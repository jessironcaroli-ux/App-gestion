
import React, { useState, useEffect, useMemo } from 'react';
import Login from './components/Login.js';
import Dashboard from './components/Dashboard.js';
import AdminView from './components/AdminView.js';
import Forms from './components/Forms.js';
import Simulation from './components/Simulation.js';
import AIAdvisor from './components/AIAdvisor.js';
import { UserRole, ExpenseType } from './types.js';

export default function App() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('dashboard');
  const [selectedClientId, setSelectedClientId] = useState(null);
  
  const [data, setData] = useState(() => {
    const saved = localStorage.getItem('finance_pyme_pro_storage_v1');
    return saved ? JSON.parse(saved) : {
      clients: {
        'demo-id': { id: 'demo-id', name: 'Empresa Demo S.A.', user: 'pyme', pass: '123', sales: [], expenses: [] }
      }
    };
  });

  useEffect(() => {
    localStorage.setItem('finance_pyme_pro_storage_v1', JSON.stringify(data));
  }, [data]);

  const handleLogin = (u, p) => {
    if (u === 'admin' && p === 'admin') {
      setUser({ role: UserRole.ADMIN, name: 'Administrador Maestro' });
      setActiveTab('admin');
    } else {
      const client = Object.values(data.clients).find(c => c.user === u && c.pass === p);
      if (client) {
        setUser({ role: UserRole.CLIENT, name: client.name, clientId: client.id });
        setSelectedClientId(client.id);
        setActiveTab('dashboard');
      } else {
        alert('Credenciales incorrectas');
      }
    }
  };

  const currentClient = data.clients[selectedClientId];

  const metrics = useMemo(() => {
    if (!currentClient) return null;
    const totalSales = (currentClient.sales || []).reduce((acc, s) => acc + (s.price * s.qty), 0);
    const fixedExpenses = (currentClient.expenses || []).filter(e => e.type === ExpenseType.FIXED).reduce((acc, e) => acc + e.amount, 0);
    const variableExpenses = (currentClient.expenses || []).filter(e => e.type === ExpenseType.VARIABLE).reduce((acc, e) => acc + e.amount, 0);
    const netProfit = totalSales - fixedExpenses - variableExpenses;
    const margin = totalSales > 0 ? (netProfit / totalSales) : 0;
    
    return { totalSales, fixedExpenses, variableExpenses, netProfit, margin };
  }, [currentClient]);

  const actions = {
    addClient: (c) => {
      const id = 'c-' + Date.now();
      setData(prev => ({ ...prev, clients: { ...prev.clients, [id]: { ...c, id, sales: [], expenses: [] } } }));
    },
    updateData: (type, item) => {
      setData(prev => ({
        ...prev,
        clients: {
          ...prev.clients,
          [selectedClientId]: {
            ...prev.clients[selectedClientId],
            [type]: [...(prev.clients[selectedClientId][type] || []), { ...item, id: Date.now() }]
          }
        }
      }));
    }
  };

  if (!user) return React.createElement(Login, { onLogin: handleLogin });

  return React.createElement('div', { className: 'min-h-screen flex flex-col' }, [
    // Header
    React.createElement('header', { key: 'h', className: 'bg-white border-b px-8 py-4 flex justify-between items-center sticky top-0 z-50 shadow-sm' }, [
      React.createElement('div', { className: 'flex items-center gap-3' }, [
        React.createElement('div', { className: 'w-10 h-10 bg-indigo-600 rounded-xl flex items-center justify-center text-white font-black shadow-lg' }, 'F'),
        React.createElement('div', null, [
            React.createElement('h1', { className: 'text-xl font-black text-slate-800' }, 'FinancePro'),
            React.createElement('p', { className: 'text-[10px] text-slate-400 font-bold uppercase tracking-widest' }, user.role === UserRole.ADMIN ? 'GestiÃ³n Central' : currentClient?.name)
        ])
      ]),
      React.createElement('button', { onClick: () => setUser(null), className: 'text-xs font-bold text-rose-500 hover:bg-rose-50 px-4 py-2 rounded-lg transition-colors' }, 'Cerrar SesiÃ³n')
    ]),

    React.createElement('div', { key: 'b', className: 'flex flex-1 overflow-hidden' }, [
      // Sidebar
      React.createElement('aside', { key: 's', className: 'w-64 bg-white border-r p-6 space-y-2 shrink-0' }, [
        user.role === UserRole.ADMIN && React.createElement('button', { onClick: () => setActiveTab('admin'), className: `w-full text-left p-3 rounded-xl font-bold transition-all ${activeTab === 'admin' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}` }, 'ðŸ¢ Empresas'),
        selectedClientId && [
          React.createElement('button', { key: 't1', onClick: () => setActiveTab('dashboard'), className: `w-full text-left p-3 rounded-xl font-bold transition-all ${activeTab === 'dashboard' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}` }, 'ðŸ“Š Dashboard'),
          React.createElement('button', { key: 't2', onClick: () => setActiveTab('forms'), className: `w-full text-left p-3 rounded-xl font-bold transition-all ${activeTab === 'forms' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}` }, 'ðŸ“ Movimientos'),
          React.createElement('button', { key: 't3', onClick: () => setActiveTab('sim'), className: `w-full text-left p-3 rounded-xl font-bold transition-all ${activeTab === 'sim' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}` }, 'ðŸ§ª Simulador'),
          React.createElement('button', { key: 't4', onClick: () => setActiveTab('ai'), className: `w-full text-left p-3 rounded-xl font-bold transition-all ${activeTab === 'ai' ? 'bg-indigo-600 text-white shadow-lg' : 'text-slate-500 hover:bg-slate-50'}` }, 'ðŸ¤– Analista IA')
        ]
      ]),
      // Content
      React.createElement('main', { key: 'm', className: 'flex-1 overflow-y-auto p-8' }, [
        activeTab === 'admin' && React.createElement(AdminView, { clients: Object.values(data.clients), onAdd: actions.addClient, onSelect: (id) => { setSelectedClientId(id); setActiveTab('dashboard'); } }),
        activeTab === 'dashboard' && metrics && React.createElement(Dashboard, { metrics, name: currentClient.name }),
        activeTab === 'forms' && React.createElement(Forms, { sales: currentClient.sales || [], expenses: currentClient.expenses || [], onAdd: actions.updateData }),
        activeTab === 'sim' && metrics && React.createElement(Simulation, { metrics }),
        activeTab === 'ai' && metrics && React.createElement(AIAdvisor, { metrics })
      ])
    ])
  ]);
}
